<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meeting - 9w.visual</title>
    <link rel="stylesheet" href="meeting.css">
    <style>
        /* Jitsi Container Styles */
        #jitsi-container {
            width: 100%;
            height: 100%;
            min-height: 100vh;
            position: relative;
            background: hsl(var(--background));
        }

        /* Ensure Jitsi iframe takes full space */
        #jitsi-container iframe {
            width: 100%;
            height: 100%;
            border: none;
            position: absolute;
            top: 0;
            left: 0;
        }

        /* Hide Jitsi container initially, show after initialization */
        #jitsi-container {
            display: none;
        }

        #jitsi-container.initialized {
            display: block;
        }

        /* Loading overlay */
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: hsl(var(--background) / 0.95);
            backdrop-filter: blur(10px);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            gap: 1.5rem;
        }

        #loading .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid hsl(var(--border));
            border-top-color: hsl(var(--primary));
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #loading p {
            font-size: 1.125rem;
            color: hsl(var(--foreground));
        }

        /* Meeting header overlay (on top of Jitsi) */
        .meeting-header-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: hsl(var(--card) / 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid hsl(var(--border));
            padding: 0.75rem 1rem;
            display: none;
            align-items: center;
            justify-content: space-between;
        }

        .meeting-header-overlay.visible {
            display: flex;
        }

        .meeting-header-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .meeting-header-room {
            font-size: 0.875rem;
            color: hsl(var(--muted-foreground));
        }

        .meeting-header-room strong {
            color: hsl(var(--foreground));
            font-weight: 600;
        }

        /* Adjust meeting ID display for Jitsi overlay */
        .meeting-id-display {
            z-index: 101;
        }

        /* Side panels should be above Jitsi */
        .side-panel {
            z-index: 102;
        }

        /* Control bar should be above Jitsi */
        .control-bar {
            z-index: 103;
        }

        /* Status message */
        .status-message {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 104;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            display: none;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        .status-message.info {
            background: hsl(var(--primary) / 0.1);
            color: hsl(var(--primary));
            border: 1px solid hsl(var(--primary) / 0.2);
        }

        .status-message.success {
            background: hsl(142 71% 45% / 0.1);
            color: hsl(142 71% 45%);
            border: 1px solid hsl(142 71% 45% / 0.2);
        }

        .status-message.error {
            background: hsl(var(--destructive) / 0.1);
            color: hsl(var(--destructive));
            border: 1px solid hsl(var(--destructive) / 0.2);
        }
    </style>
</head>
<body>
    <div class="meeting-container">
        <!-- Main content area -->
        <div class="meeting-main">
            <!-- Jitsi Meeting Container -->
            <div id="jitsi-container" class="jitsi-container"></div>

            <!-- Meeting ID Display (Draggable) -->
            <div id="meetingIdDisplay" class="meeting-id-display" draggable="true">
                <div class="meeting-id-content">
                    <span class="meeting-id-label">Meeting ID:</span>
                    <span id="meetingIdValue" class="meeting-id-value">-</span>
                    <button id="copyMeetingIdBtn" class="copy-meeting-id-btn" onclick="copyMeetingId()" title="Copy Meeting ID">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                    </button>
                </div>
                <div id="roomPasswordDisplay" class="room-password-display" style="display: none;">
                    <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                    <span id="roomPasswordValue" class="room-password-value">Protected</span>
                </div>
            </div>

            <!-- Side panels (hidden by default) -->
            <div id="chatPanel" class="side-panel" style="display: none;">
                <div class="panel-header">
                    <div class="panel-header-content">
                        <div class="panel-header-icon">
                            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                            </svg>
                        </div>
                        <div class="panel-header-text">
                            <h3>Chat</h3>
                            <span id="chatMessageCount" class="panel-header-subtitle">0 messages</span>
                        </div>
                    </div>
                    <button class="panel-close" onclick="toggleChat()">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="panel-content" id="chatMessages">
                    <!-- Chat messages will be added here -->
                </div>
                <div class="panel-footer">
                    <input type="text" id="chatInput" placeholder="Type a message..." onkeypress="if(event.key === 'Enter') sendChatMessage()">
                    <button onclick="sendChatMessage()">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                        </svg>
                    </button>
                </div>
            </div>

            <div id="participantsPanel" class="side-panel" style="display: none;">
                <div class="panel-header">
                    <h3 id="participantsCount">Participants (1)</h3>
                    <button class="panel-close" onclick="toggleParticipants()">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="panel-content" id="participantsList">
                    <!-- Participants list will be added here -->
                </div>
                <!-- Admin Controls (only visible to admin) -->
                <div id="adminControls" class="panel-footer admin-controls" style="display: none;">
                    <button id="setPasswordBtn" class="btn btn-secondary btn-sm" onclick="openSetPasswordModal()">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                        </svg>
                        <span>Set Password</span>
                    </button>
                    <button id="resetPasswordBtn" class="btn btn-secondary btn-sm" onclick="openResetPasswordModal()" style="display: none;">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z" />
                        </svg>
                        <span>Remove Password</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Control bar -->
        <div class="control-bar">
            <div class="control-bar-content">
                <!-- Left controls -->
                <div class="control-group">
                    <!-- Mute and Camera controls are handled by Jitsi -->
                    <!-- We keep these for UI consistency, but they'll be hidden or disabled -->
                </div>

                <!-- Center controls -->
                <div class="control-group">
                    <!-- Screen sharing is handled by Jitsi desktop button -->
                    <!-- We keep chat and participants buttons for our custom panels -->
                    <button id="chatBtn" class="control-btn" onclick="toggleChat()">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                        </svg>
                        <span class="control-label">Chat</span>
                    </button>

                    <button id="participantsBtn" class="control-btn" onclick="toggleParticipants()">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                        <span class="control-label">Participants</span>
                    </button>

                    <button id="configPasswordBtn" class="control-btn" onclick="togglePasswordConfig()" style="display: none;">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                        </svg>
                        <span class="control-label">Config Room Password</span>
                    </button>
                </div>

                <!-- Right controls -->
                <div class="control-group">
                    <button id="endCallBtn" class="control-btn control-btn-danger" onclick="leaveMeeting()">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M3 3l8.735 8.735a2.5 2.5 0 010 3.53L3 21" />
                        </svg>
                        <span class="control-label">Leave</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Status Display -->
        <div id="status" class="status-message"></div>

        <!-- Loading Overlay -->
        <div id="loading">
            <div class="spinner"></div>
            <p>Connecting to meeting...</p>
        </div>

        <!-- Password Modal -->
        <div id="passwordModal" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Room Password Required</h3>
                    <button class="modal-close" onclick="closePasswordModal()">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <p class="modal-description">This room is protected by a password. Please enter the password to join.</p>
                    <div class="modal-input-group">
                        <input type="password" id="passwordInput" placeholder="Enter password..." class="modal-input" onkeypress="if(event.key === 'Enter') submitPassword()">
                        <button type="button" class="password-toggle" onclick="togglePasswordVisibility()">
                            <svg id="passwordShowIcon" width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: none;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                            <svg id="passwordHideIcon" width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                            </svg>
                        </button>
                    </div>
                    <div id="passwordError" class="modal-error" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closePasswordModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="submitPassword()">Join Room</button>
                </div>
            </div>
        </div>

        <!-- Admin Password Modal -->
        <div id="adminPasswordModal" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="adminPasswordModalTitle">Set Room Password</h3>
                    <button class="modal-close" onclick="closeAdminPasswordModal()">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <p class="modal-description" id="adminPasswordModalDescription">Set a password to protect this room. Users will need to enter this password to join.</p>
                    <div class="modal-input-group">
                        <input type="password" id="adminPasswordInput" placeholder="Enter password..." class="modal-input" onkeypress="if(event.key === 'Enter') submitAdminPassword()">
                        <button type="button" class="password-toggle" onclick="toggleAdminPasswordVisibility()">
                            <svg id="adminPasswordShowIcon" width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: none;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                            <svg id="adminPasswordHideIcon" width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                            </svg>
                        </button>
                    </div>
                    <div id="adminPasswordError" class="modal-error" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeAdminPasswordModal()">Cancel</button>
                    <button class="btn btn-primary" id="adminPasswordSubmitBtn" onclick="submitAdminPassword()">Set Password</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Load Jitsi Meet External API -->
    <script src="https://meet.jit.si/external_api.js"></script>
    
    <!-- Load Socket.io -->
    <script src="/socket.io/socket.io.js"></script>
    
    <!-- Load configuration -->
    <script src="config.js"></script>
    
    <!-- Load room management -->
    <script src="room-manager.js"></script>
    
    <!-- Load Jitsi configuration -->
    <script src="jitsi-config.js"></script>
    
    <!-- Load main application logic -->
    <script src="jitsi-app.js"></script>
    
    <script>
        // Initialize draggable meeting ID display
        document.addEventListener('DOMContentLoaded', () => {
            const meetingIdDisplay = document.getElementById('meetingIdDisplay');
            if (meetingIdDisplay) {
                let isDragging = false;
                let currentX = 0;
                let currentY = 0;
                let initialX = 0;
                let initialY = 0;

                // Load saved position
                const savedPosition = localStorage.getItem('meetingIdPosition');
                if (savedPosition) {
                    try {
                        const pos = JSON.parse(savedPosition);
                        meetingIdDisplay.style.left = pos.x + 'px';
                        meetingIdDisplay.style.top = pos.y + 'px';
                        currentX = pos.x;
                        currentY = pos.y;
                    } catch (e) {
                        console.error('Error loading saved position:', e);
                    }
                }

                // Mouse events
                meetingIdDisplay.addEventListener('mousedown', (e) => {
                    if (e.target.closest('button') || e.target.closest('svg')) {
                        return;
                    }
                    isDragging = true;
                    meetingIdDisplay.classList.add('dragging');
                    initialX = e.clientX - currentX;
                    initialY = e.clientY - currentY;
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    e.preventDefault();
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                    
                    const maxX = window.innerWidth - meetingIdDisplay.offsetWidth;
                    const maxY = window.innerHeight - meetingIdDisplay.offsetHeight - 100;
                    currentX = Math.max(0, Math.min(currentX, maxX));
                    currentY = Math.max(0, Math.min(currentY, maxY));
                    
                    meetingIdDisplay.style.left = currentX + 'px';
                    meetingIdDisplay.style.top = currentY + 'px';
                });

                document.addEventListener('mouseup', () => {
                    if (isDragging) {
                        isDragging = false;
                        meetingIdDisplay.classList.remove('dragging');
                        localStorage.setItem('meetingIdPosition', JSON.stringify({ x: currentX, y: currentY }));
                    }
                });

                // Touch events for mobile
                meetingIdDisplay.addEventListener('touchstart', (e) => {
                    if (e.target.closest('button') || e.target.closest('svg')) {
                        return;
                    }
                    isDragging = true;
                    meetingIdDisplay.classList.add('dragging');
                    const touch = e.touches[0];
                    initialX = touch.clientX - currentX;
                    initialY = touch.clientY - currentY;
                });

                document.addEventListener('touchmove', (e) => {
                    if (!isDragging) return;
                    e.preventDefault();
                    const touch = e.touches[0];
                    currentX = touch.clientX - initialX;
                    currentY = touch.clientY - initialY;
                    
                    const maxX = window.innerWidth - meetingIdDisplay.offsetWidth;
                    const maxY = window.innerHeight - meetingIdDisplay.offsetHeight - 100;
                    currentX = Math.max(0, Math.min(currentX, maxX));
                    currentY = Math.max(0, Math.min(currentY, maxY));
                    
                    meetingIdDisplay.style.left = currentX + 'px';
                    meetingIdDisplay.style.top = currentY + 'px';
                });

                document.addEventListener('touchend', () => {
                    if (isDragging) {
                        isDragging = false;
                        meetingIdDisplay.classList.remove('dragging');
                        localStorage.setItem('meetingIdPosition', JSON.stringify({ x: currentX, y: currentY }));
                    }
                });
            }
        });
    </script>
</body>
</html>

