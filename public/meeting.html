<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meeting - 9w.visual</title>
    <link rel="stylesheet" href="meeting.css">
</head>
<body>
    <div class="meeting-container">
        <!-- Main content area -->
        <div class="meeting-main">
            <!-- Video grid -->
            <div class="video-grid-container">
                <!-- Meeting ID Display (Draggable) -->
                <div id="meetingIdDisplay" class="meeting-id-display" draggable="true">
                    <div class="meeting-id-content">
                        <span class="meeting-id-label">Meeting ID:</span>
                        <span id="meetingIdValue" class="meeting-id-value">-</span>
                        <button id="copyMeetingIdBtn" class="copy-meeting-id-btn" onclick="copyMeetingId()" title="Copy Meeting ID">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                            </svg>
                        </button>
                    </div>
                    <div id="roomPasswordDisplay" class="room-password-display" style="display: none;">
                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                        </svg>
                        <span id="roomPasswordValue" class="room-password-value">Protected</span>
                    </div>
                </div>
                <div class="video-grid" id="videoContainer">
                    <!-- Video tiles will be added dynamically -->
                </div>
            </div>

            <!-- Side panels (hidden by default) -->
            <div id="chatPanel" class="side-panel" style="display: none;">
                <div class="panel-header">
                    <div class="panel-header-content">
                        <div class="panel-header-icon">
                            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                            </svg>
                        </div>
                        <div class="panel-header-text">
                            <h3>Chat</h3>
                            <span id="chatMessageCount" class="panel-header-subtitle">0 messages</span>
                        </div>
                    </div>
                    <button class="panel-close" onclick="toggleChat()">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="panel-content" id="chatMessages">
                    <!-- Chat messages will be added here -->
                </div>
                <div class="panel-footer">
                    <input type="text" id="chatInput" placeholder="Type a message..." onkeypress="if(event.key === 'Enter') sendChatMessage()">
                    <button onclick="sendChatMessage()">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                        </svg>
                    </button>
                </div>
            </div>

            <div id="participantsPanel" class="side-panel" style="display: none;">
                <div class="panel-header">
                    <h3 id="participantsCount">Participants (1)</h3>
                    <button class="panel-close" onclick="toggleParticipants()">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="panel-content" id="participantsList">
                    <!-- Participants list will be added here -->
                </div>
                <!-- Admin Controls (only visible to admin) -->
                <div id="adminControls" class="panel-footer admin-controls" style="display: none;">
                    <button id="setPasswordBtn" class="btn btn-secondary btn-sm" onclick="openSetPasswordModal()">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                        </svg>
                        <span>Set Password</span>
                    </button>
                    <button id="resetPasswordBtn" class="btn btn-secondary btn-sm" onclick="openResetPasswordModal()" style="display: none;">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z" />
                        </svg>
                        <span>Remove Password</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Control bar -->
        <div class="control-bar">
            <div class="control-bar-content">
                <!-- Left controls -->
                <div class="control-group">
                    <button id="muteBtn" class="control-btn" onclick="toggleMute()">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                        </svg>
                        <span class="control-label">Mute</span>
                    </button>

                    <button id="cameraBtn" class="control-btn" onclick="toggleCamera()">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                        <span class="control-label">Camera</span>
                    </button>
                </div>

                <!-- Center controls -->
                <div class="control-group">
                    <button id="screenShareBtn" class="control-btn" onclick="toggleScreenShare()">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                        <span class="control-label">Share Screen</span>
                    </button>

                    <button id="chatBtn" class="control-btn" onclick="toggleChat()">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                        </svg>
                        <span class="control-label">Chat</span>
                    </button>

                    <button id="participantsBtn" class="control-btn" onclick="toggleParticipants()">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                        <span class="control-label">Participants</span>
                    </button>

                    <button id="configPasswordBtn" class="control-btn" onclick="togglePasswordConfig()" style="display: none;">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                        </svg>
                        <span class="control-label">Config Room Password</span>
                    </button>
                </div>

                <!-- Right controls -->
                <div class="control-group">
                    <button id="endCallBtn" class="control-btn control-btn-danger" onclick="endCall()">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M3 3l8.735 8.735a2.5 2.5 0 010 3.53L3 21" />
                        </svg>
                        <span class="control-label">Leave</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Status Display -->
        <div id="status" class="status-message"></div>

        <!-- Password Modal -->
        <div id="passwordModal" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Room Password Required</h3>
                    <button class="modal-close" onclick="closePasswordModal()">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <p class="modal-description">This room is protected by a password. Please enter the password to join.</p>
                    <form onsubmit="event.preventDefault(); submitPassword(); return false;">
                        <div class="modal-input-group">
                            <input type="password" id="passwordInput" placeholder="Enter password..." class="modal-input" onkeypress="if(event.key === 'Enter') { event.preventDefault(); submitPassword(); }">
                        <button type="button" class="password-toggle" onclick="togglePasswordVisibility()">
                            <svg id="passwordShowIcon" width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: none;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                            <svg id="passwordHideIcon" width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                            </svg>
                        </button>
                        </div>
                        <div id="passwordError" class="modal-error" style="display: none;"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closePasswordModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="submitPassword()">Join Room</button>
                </div>
            </div>
        </div>

        <!-- Admin Password Modal -->
        <div id="adminPasswordModal" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="adminPasswordModalTitle">Set Room Password</h3>
                    <button class="modal-close" onclick="closeAdminPasswordModal()">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <p class="modal-description" id="adminPasswordModalDescription">Set a password to protect this room. Users will need to enter this password to join.</p>
                    <form onsubmit="event.preventDefault(); if(document.getElementById('adminPasswordSubmitBtn').onclick) document.getElementById('adminPasswordSubmitBtn').onclick(); return false;">
                        <div class="modal-input-group">
                            <input type="password" id="adminPasswordInput" placeholder="Enter password..." class="modal-input" onkeypress="if(event.key === 'Enter') { event.preventDefault(); if(document.getElementById('adminPasswordSubmitBtn').onclick) document.getElementById('adminPasswordSubmitBtn').onclick(); }">
                            <button type="button" class="password-toggle" onclick="toggleAdminPasswordVisibility()">
                                <svg id="adminPasswordShowIcon" width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: none;">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                                <svg id="adminPasswordHideIcon" width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                                </svg>
                            </button>
                        </div>
                        <div id="adminPasswordError" class="modal-error" style="display: none;"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeAdminPasswordModal()">Cancel</button>
                    <button class="btn btn-primary" id="adminPasswordSubmitBtn" onclick="submitAdminPassword()">Set Password</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Load libraries -->
    <!-- Load mediasoup-client - try server bundle first (most reliable), then CDN fallbacks -->
    <script>
        // Function to load mediasoup-client with multiple fallbacks
        // Priority: 1) Server bundle, 2) esm.sh CDN, 3) skypack CDN
        function loadMediasoupClient(callback) {
            // Priority 1: Try server-bundled version (most reliable, no external dependency)
            console.log('üì¶ Loading mediasoup-client from server bundle...');
            const script = document.createElement('script');
            script.src = '/mediasoup-client-bundle.js';
            script.async = false;
            
            script.onload = function() {
                console.log('üì¶ Mediasoup bundle script loaded, checking for global...');
                setTimeout(() => {
                    // Check for mediasoup in multiple possible locations
                    const mediasoupLib = window.mediasoup || window.mediasoupClient || (typeof mediasoup !== 'undefined' ? mediasoup : null);
                    
                    if (mediasoupLib && typeof mediasoupLib.Device !== 'undefined') {
                        // Make sure it's available globally
                        if (!window.mediasoup) {
                            window.mediasoup = mediasoupLib;
                        }
                        console.log('‚úÖ Mediasoup client loaded from server bundle');
                        console.log('üìã Mediasoup Device available:', typeof window.mediasoup.Device !== 'undefined');
                        callback();
                    } else {
                        console.error('‚ùå Mediasoup bundle loaded but Device class not found');
                        console.log('Available globals:', Object.keys(window).filter(k => k.toLowerCase().includes('media')));
                        // Try CDN fallback
                        loadMediasoupClientCDN(callback);
                    }
                }, 200);
            };
            
            script.onerror = function() {
                console.error('‚ùå Server bundle not found, trying CDN fallback...');
                loadMediasoupClientCDN(callback);
            };
            
            document.head.appendChild(script);
        }
        
        // Fallback: Try esm.sh CDN (converts Node modules to browser-compatible)
        function loadMediasoupClientCDN(callback) {
            console.log('üîÑ Trying esm.sh CDN...');
            const script = document.createElement('script');
            script.type = 'module';
            script.textContent = `
                import * as mediasoupClient from 'https://esm.sh/mediasoup-client@3.7.9';
                window.mediasoup = mediasoupClient;
                console.log('‚úÖ Mediasoup client loaded from esm.sh');
                window.mediasoupLoaded = true;
            `;
            script.onerror = function() {
                console.error('‚ùå esm.sh failed, trying skypack...');
                loadMediasoupClientSkypack(callback);
            };
            document.head.appendChild(script);
            
            // Wait for the module to load
            const checkLoaded = setInterval(() => {
                if (window.mediasoupLoaded && window.mediasoup) {
                    clearInterval(checkLoaded);
                    callback();
                }
            }, 100);
            
            // Timeout after 10 seconds
            setTimeout(() => {
                if (!window.mediasoupLoaded) {
                    clearInterval(checkLoaded);
                    console.error('‚ùå esm.sh timeout, trying skypack...');
                    loadMediasoupClientSkypack(callback);
                }
            }, 10000);
        }
        
        // Last resort: Try skypack CDN
        function loadMediasoupClientSkypack(callback) {
            console.log('üîÑ Trying skypack CDN (last resort)...');
            const script = document.createElement('script');
            script.type = 'module';
            script.textContent = `
                import * as mediasoupClient from 'https://cdn.skypack.dev/mediasoup-client@3.7.9';
                window.mediasoup = mediasoupClient;
                console.log('‚úÖ Mediasoup client loaded from skypack');
                window.mediasoupLoaded = true;
            `;
            script.onerror = function() {
                console.error('‚ùå All CDN attempts failed');
                alert('Failed to load mediasoup-client library. Please check your internet connection and refresh the page.');
            };
            document.head.appendChild(script);
            
            // Wait for the module to load
            const checkLoaded = setInterval(() => {
                if (window.mediasoupLoaded && window.mediasoup) {
                    clearInterval(checkLoaded);
                    callback();
                }
            }, 100);
            
            // Timeout after 10 seconds
            setTimeout(() => {
                if (!window.mediasoupLoaded) {
                    clearInterval(checkLoaded);
                    console.error('‚ùå All CDN attempts failed');
                    alert('Failed to load mediasoup-client library. Please check your internet connection and refresh the page.');
                }
            }, 10000);
        }
        
        // Load mediasoup-client first, then other scripts
        loadMediasoupClient(() => {
            // Load config first (needed for SERVER_URL)
            const configScript = document.createElement('script');
            configScript.src = 'config.js';
            configScript.onload = () => {
                console.log('‚úÖ config.js loaded');
                
                // Then load socket.io
                const socketScript = document.createElement('script');
                socketScript.src = '/socket.io/socket.io.js';
                socketScript.onload = () => {
                    console.log('‚úÖ socket.io.js loaded');
                    
                    // Wait a bit for socket.io to be ready
                    setTimeout(() => {
                        // Finally load our client script
                        const clientScript = document.createElement('script');
                        clientScript.src = 'client-mediasoup.js';
                        clientScript.onload = () => {
                            console.log('‚úÖ client-mediasoup.js loaded');
                            // Wait a bit to ensure all functions are defined
                            setTimeout(() => {
                                // Try to call initializeMeeting from window
                                const initFn = window.initializeMeeting || (typeof initializeMeeting !== 'undefined' ? initializeMeeting : null);
                                if (typeof initFn === 'function') {
                                    console.log('üöÄ Calling initializeMeeting...');
                                    initFn();
                                } else {
                                    console.warn('‚ö†Ô∏è initializeMeeting function not found, trying direct initialization...');
                                    // Try alternative: manually trigger initialization
                                    const urlParams = new URLSearchParams(window.location.search);
                                    const roomId = urlParams.get('room');
                                    const name = urlParams.get('name');
                                    const password = urlParams.get('password');
                                    
                                    // Wait a bit more for functions to be defined
                                    setTimeout(() => {
                                        const joinFn = window.joinRoom || (typeof joinRoom !== 'undefined' ? joinRoom : null);
                                        if (roomId && name && typeof joinFn === 'function') {
                                            console.log('üöÄ Manually joining room...');
                                            joinFn(roomId, decodeURIComponent(name), password ? decodeURIComponent(password) : null);
                                        } else {
                                            console.error('‚ùå Cannot initialize: joinRoom function not found');
                                            showStatus('Failed to initialize meeting. Please refresh the page.', 'error');
                                        }
                                    }, 500);
                                }
                            }, 300);
                        };
                        clientScript.onerror = () => {
                            console.error('‚ùå Failed to load client-mediasoup.js');
                            alert('Failed to load client script. Please refresh the page.');
                        };
                        document.head.appendChild(clientScript);
                    }, 100);
                };
                socketScript.onerror = () => {
                    console.error('‚ùå Failed to load socket.io.js');
                    alert('Failed to load Socket.io. Please refresh the page.');
                };
                document.head.appendChild(socketScript);
            };
            configScript.onerror = () => {
                console.error('‚ùå Failed to load config.js');
            };
            document.head.appendChild(configScript);
        });
    </script>
</body>
</html>

